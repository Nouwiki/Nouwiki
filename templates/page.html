<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <title></title>

  <style type="text/css">code{white-space: pre;}</style>
  <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <link rel="stylesheet" href="/assets/css/normalize.css">
  <link rel="stylesheet" href="/assets/css/github-markdown.css">
  <link rel="stylesheet" href="/assets/css/content.css">
  <link rel="stylesheet" href="/assets/css/nouwiki.css">
  <link rel="stylesheet" href="/assets/css/routine.css">
  <link rel="stylesheet" href="/assets/css/buttons.css">
  <!--<link rel="stylesheet" href="/assets/js/highlight.js/default.min.css">-->
</head>
<body class="{{ .Mode }}">

<div id="history" class="markdown-body"></div>

<a href="/" onClick="cleanHistory();"><button id="root">ðŸŒŽ</button></a>
<a href="/{{ .Wiki }}/wiki/" onClick="cleanHistory();"><button id="home">Home</button></a>
<button id="discard">Discard</button>
<button id="edit" class="button">Edit</button>
<button id="view">Preview</button>
<button id="save">Save</button>

<div id="content" class="markdown-body">
{{ .Content }}
</div>

<div id="preview">
</div>

<div id="editor_container">
  <div id="editor"></div>
</div>
<script src="/assets/js/origin.js"></script>
<script src="/assets/js/jquery.js"></script>
<script type="text/javascript">
/*
- One problem:
  - If I leave nouwiki in the tab and hit back, will it still be there?

- Do we only allow continuation of travel on:
  - clicking a link
  - clicking a link or entering a page on travel, from current tab
  - clicking a link or entering any page, from current tab

- Okay we need to implement:
  - Travers history localstorage
  - Add to traverse on click wikilink
  - Don't add to traverse on entering not through wikilink
  - Store traverse history in memory cause other sessions can owerwrite localstorage
  - Check when you enter if this page is the current page in traverse history
*/

  var t = JSON.parse(localStorage.getItem('traversion')) || [];
  var a = JSON.parse(localStorage.getItem('traversion_abs')) || [];
  var c = JSON.parse(localStorage.getItem('travers_current')) || 0;
  cleanLocalStorageHistory();
  window.onbeforeunload = function(event) {
    localStorage.setItem('traversion', JSON.stringify(t));
    localStorage.setItem('traversion_abs', JSON.stringify(a));
    localStorage.setItem('travers_current', JSON.stringify(c));
  };

  function setHTML() {
    var html = ""
    for (var i = 0; i < t.length; i++) {
      if (i == c-1) {
        html += "<b>"+t[i]+"</b>";
      } else {
        html += "<a href='"+a[i]+"'>"+t[i]+"</a>";
      }
      if (i != t.length-1) {
        html += " > ";
      }
    }
    document.getElementById("history").innerHTML = html;
    $("#history a").click(goingOut);
  }

  var isorigin = new RegExp(origin);
  var href;
  $("a").click(goingOut);

  function goingOut(e) {
    var ctrl = e.ctrlKey;
    href = $(this).attr('href');
    if (isorigin.test(href) && !ctrl) {
      e.preventDefault();
      //updateHistory(href)
      window.location.href = href;
    } else {
      if (href.indexOf('http://') === 0 || href.indexOf('https://') === 0) {
        // Go jim morrison, GO!
      } else if (!ctrl) {
        e.preventDefault();
        //updateHistory(href)
        window.location.href = href;
      }
    }
  }

  // Placed here (right after #history) for max speed

  //cleanHistory();
  checkContinue();

  function cleanHistory() {
    localStorage.setItem('traversion', JSON.stringify([]));
    localStorage.setItem('traversion_abs', JSON.stringify([]));
    localStorage.setItem('travers_current', JSON.stringify(0));
    t = [];
    a = [];
    c = 0;
  }

  function cleanLocalStorageHistory() {
    localStorage.setItem('traversion', JSON.stringify([]));
    localStorage.setItem('traversion_abs', JSON.stringify([]));
    localStorage.setItem('travers_current', JSON.stringify(0));
  }

  function updateHistory(href) {
    var abs = absolutePath(href);
    if (a.indexOf(abs) == -1) {
      var next = pageFromHref(href);
      var n = c;
      t = t.slice(0, c);
      t[n] = next;
      a = a.slice(0, c);
      a[n] = abs;
      //localStorage.setItem('traversion', JSON.stringify(t))
      //localStorage.setItem('traversion_abs', JSON.stringify(a))
      c = a.lastIndexOf(abs)+1;
      //localStorage.setItem('travers_current', JSON.stringify(c))
    } else {
      //localStorage.setItem('traversion', JSON.stringify(t))
      //localStorage.setItem('traversion_abs', JSON.stringify(a))
      c = a.lastIndexOf(abs)+1;
      //localStorage.setItem('travers_current', JSON.stringify(c))
    }
  }

  function pageFromHref(href) {
    var s = href.split("/")
    s = s[s.length-1]
    s = s.split("?")[0];
    if (s == "") {
      s = "Index";
    }
    return decodeURI(s);
  }

  function checkContinue() {
    var href = window.location.href;
    var abs = absolutePath(href);

    if (a.indexOf(abs) == -1) {
      //cleanHistory();
      updateHistory(href);
    } else {
      c = a.lastIndexOf(abs)+1;
      //localStorage.setItem('travers_current', JSON.stringify(c))
    }

    setHTML();
  }

  function absolutePath(href) {
    href = href.split("?")[0];
    var link = document.createElement("a");
    link.href = href;
    return (link.protocol+"//"+link.host+link.pathname+link.search+link.hash);
  }
</script>
<script src="/assets/js/jquery.history.js"></script>
<script src="/assets/js/behave.js"></script>
<script src="/assets/js/routine.js"></script>
<script src="/assets/js/white.js"></script>
<script src="/assets/js/ace-builds/src-min-noconflict/ace.js"></script>
<script src="/assets/js/nouwiki.js"></script>
</body>
</html>
